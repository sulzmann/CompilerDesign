<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Martin Sulzmann" />
  <title>Parser Combinators</title>
  <style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">Parser Combinators</h1>
  <p class="author">
Martin Sulzmann
  </p>
</div>
<div id="functional-parsers" class="slide section level1">
<h1>Functional Parsers</h1>
<p>For concreteness, we will use Haskell. We could (to a large extent)
equally well use Scala, C++11, Java8, …</p>
<p>So, what is a parser?</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Parser</span> s <span class="ot">=</span> <span class="dt">String</span> <span class="ot">-&gt;</span> (s,<span class="dt">String</span>)</span></code></pre></div>
<ul>
<li><p>A parser is a function</p></li>
<li><p>The input is a string</p></li>
<li><p>The output is some result <code>s</code>, e.g. AST and the
remaining string part we didn’t process.</p></li>
</ul>
<p>A parser combinator is a special-purpose parsing function. For
example, consider</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">num ::</span> <span class="dt">Parser</span> <span class="dt">Int</span></span></code></pre></div>
<p>which parses digits and turns them into integer numbers</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>num <span class="st">&quot;0123 + 234&quot;</span>  <span class="op">==&gt;</span> (<span class="dt">IntVal</span> <span class="dv">123</span>,<span class="st">&quot; + 234&quot;</span>)</span></code></pre></div>
<p>There are two issues we need to address:</p>
<ul>
<li>Parsing my fail, for example consider</li>
</ul>
<pre><code>num &quot;xyz&quot;</code></pre>
<ul>
<li>The result of parsing may be ambiguous, for example consider
<code>exp "1+2*3"</code> where <code>exp</code> parses expressions. The
result could be either one of the following two</li>
</ul>
<pre><code>  Add (IntVal 1) (Mul (IntVal 2) (IntVal 3))

  Mul (Add (IntVal 1) (IntVal 2)) (IntVal 3)</code></pre>
<p>To address the above, we simply return a list of possible parse
results</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Parser</span> s <span class="ot">=</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [(s,<span class="dt">String</span>)]</span></code></pre></div>
<p>Technically, this makes parsing non-deterministic but we will always
favor the <em>first</em> result</p>
</div>
<div id="roll-your-own-monad---the-parser-monad"
class="slide section level1">
<h1>Roll your own Monad - The Parser Monad</h1>
<p>A parser is a function which takes a string and yields a result (of
some type <code>a</code>) and the remaining string. Our parser even
yields a list of possible parse results, although, we will generally
always favor the first successful parse result.</p>
<p>What’s the deal with <em>monads</em>? It’s a technical term to refer
to side-effecting computations. Parsing produces a result, e.g. AST, and
as a side-effect consumes (parts) of some input string.</p>
<h2 id="the-parser-function">The parser function</h2>
<div class="sourceCode" id="cb7"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Parser</span> a <span class="ot">=</span> <span class="dt">Parser</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> [(a,<span class="dt">String</span>)])</span></code></pre></div>
<p>Running the parser is simple. Apply the parse function on some input
string.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">run ::</span> <span class="dt">Parser</span> t <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [(t, <span class="dt">String</span>)]</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>run (<span class="dt">Parser</span> p) s <span class="ot">=</span> p s</span></code></pre></div>
<p>A practical use of this parser appears rather clumsy. As it seems we
need to explicitly thread through the parser function and its parser
state. Fortunately, we can capture the essence of our parser in a
monad.</p>
<h2 id="basic-monadic-parser-combinators">Basic Monadic Parser
Combinators</h2>
<div class="sourceCode" id="cb9"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> <span class="dt">Parser</span> <span class="kw">where</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> a <span class="ot">=</span> <span class="dt">Parser</span> (\cs <span class="ot">-&gt;</span> [(a,cs)])</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  p <span class="op">&gt;&gt;=</span> f  <span class="ot">=</span> <span class="dt">Parser</span> (\cs <span class="ot">-&gt;</span> <span class="fu">concat</span> [parse (f a) cs&#39; <span class="op">|</span> (a,cs&#39;) <span class="ot">&lt;-</span> parse p cs])</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>parse (<span class="dt">Parser</span> p) <span class="ot">=</span> p</span></code></pre></div>
<ul>
<li><p>The <code>return</code> function returns its arguments and leaves
the input unchanged.</p></li>
<li><p>The <code>&gt;&gt;=</code> takes as its first argument a parse
result <code>Parser a</code> and as its second argment a function
<code>b -&gt; Parser b</code> which consumes the result and produces a
new parser.</p></li>
<li><p>Helper <code>concat</code> combines the individual results and
<code>parse</code> extracts the parsing function.</p></li>
</ul>
<p>Thanks to the <code>do</code> syntax the specification of parsers
becomes straightforward as we will see shortly.</p>
<p>First, we define another set of combinators to signal failure and
combine the sets (i.e. lists) of different parse results.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">MonadPlus</span> <span class="dt">Parser</span> <span class="kw">where</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  mzero <span class="ot">=</span> <span class="dt">Parser</span> (\cs <span class="ot">-&gt;</span>[])</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">`mplus`</span> q <span class="ot">=</span> <span class="dt">Parser</span> (\cs <span class="ot">-&gt;</span> parse p cs <span class="op">++</span> parse q cs)</span></code></pre></div>
<h2 id="monad-laws">Monad Laws</h2>
<p>Besides a systematic way to specify computations via combinators
<code>return</code> and `&gt;&gt;=’, we assume that monad definitions
satisfy certain laws such as left/right identity and associativity.
Otherwise, the “computation” is not a monad. Our parser monad satisfies
the monad laws. For those you are interested in the details, please
check out <a
href="Monad%20laws">http://www.haskell.org/haskellwiki/Monad_laws</a></p>
<h2 id="some-derived-combinators">Some derived combinators</h2>
<p>Now, the fun starts. Let’s define some parser abstractions.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ot">(+++) ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> a</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>(<span class="op">+++</span>) p q <span class="ot">=</span> <span class="dt">Parser</span> ( \cs <span class="ot">-&gt;</span> <span class="kw">case</span> parse (p <span class="ot">`mplus`</span> q) cs <span class="kw">of</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                           []     <span class="ot">-&gt;</span> []</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                           (x<span class="op">:</span>xs) <span class="ot">-&gt;</span> [x] )</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ot">item ::</span> <span class="dt">Parser</span> <span class="dt">Char</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>item <span class="ot">=</span> <span class="dt">Parser</span> (\cs <span class="ot">-&gt;</span> <span class="kw">case</span> cs <span class="kw">of</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;&quot;</span>     <span class="ot">-&gt;</span> []</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                       (c<span class="op">:</span>cs) <span class="ot">-&gt;</span> [(c,cs)])</span></code></pre></div>
<ul>
<li><p><code>(+++)</code> implements a deterministic first choice among
several parse results (e.g. could be used in an LL-style parser with
arbitrary look-ahead)</p></li>
<li><p><code>item</code> unconditionally parse a single
character</p></li>
</ul>
<h2 id="combinators-for-strings-and-characters">Combinators for strings
and characters</h2>
<div class="sourceCode" id="cb12"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ot">sat ::</span> (<span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Char</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>sat p <span class="ot">=</span> <span class="kw">do</span> { c <span class="ot">&lt;-</span> item; <span class="kw">if</span> p c <span class="kw">then</span> <span class="fu">return</span> c <span class="kw">else</span> mzero }</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="ot">char ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Char</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>char c <span class="ot">=</span> sat (c <span class="op">==</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="ot">string ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">String</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>string <span class="st">&quot;&quot;</span> <span class="ot">=</span> <span class="fu">return</span> <span class="st">&quot;&quot;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>string (c<span class="op">:</span>cs) <span class="ot">=</span> <span class="kw">do</span> {char c; string cs; <span class="fu">return</span> (c<span class="op">:</span>cs)}</span></code></pre></div>
<ul>
<li><code>sat</code> only parses a character if a condition is
satisfied</li>
<li><code>char</code> is conveniently defined in terms of
<code>sat</code></li>
<li><code>string</code> recurses over the given string</li>
<li>Above equivalent to (<code>;</code> versus layout rule)</li>
</ul>
<div class="sourceCode" id="cb13"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ot">string ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">String</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>string <span class="st">&quot;&quot;</span> <span class="ot">=</span> <span class="fu">return</span> <span class="st">&quot;&quot;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>string (c<span class="op">:</span>cs) <span class="ot">=</span> <span class="kw">do</span>  char c</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                    string cs</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">return</span> (c<span class="op">:</span>cs)</span></code></pre></div>
<h2 id="tokens">Tokens</h2>
<div class="sourceCode" id="cb14"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ot">space ::</span> <span class="dt">Parser</span> <span class="dt">String</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>space <span class="ot">=</span> many (sat (\c <span class="ot">-&gt;</span> <span class="kw">case</span> c <span class="kw">of</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                          <span class="ch">&#39; &#39;</span>  <span class="ot">-&gt;</span> <span class="dt">True</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                          <span class="ch">&#39;\t&#39;</span> <span class="ot">-&gt;</span> <span class="dt">True</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                          _    <span class="ot">-&gt;</span> <span class="dt">False</span>))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="ot">token ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> a </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>token p <span class="ot">=</span> <span class="kw">do</span> {space; a <span class="ot">&lt;-</span> p; space; <span class="fu">return</span> a}</span></code></pre></div>
<p>In parsing, we are generally only interested in character sequences
which are not separated by white-space (commonly referred to as a
token).</p>
<p><code>token</code> parses a token and throws away any
leading/trailing spaces</p>
<h2 id="combinators-for-optional-and-repetitive-parsing">Combinators for
optional and repetitive parsing</h2>
<div class="sourceCode" id="cb15"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ot">option ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> [a]</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>option p <span class="ot">=</span> (<span class="kw">do</span> x <span class="ot">&lt;-</span> p</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>               <span class="fu">return</span> [x])</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>           <span class="op">+++</span> <span class="fu">return</span> []</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="ot">many ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> [a]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>many p <span class="ot">=</span> many1 p <span class="op">+++</span> <span class="fu">return</span> []</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="ot">many1 ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> [a]</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>many1 p <span class="ot">=</span> <span class="kw">do</span> {a <span class="ot">&lt;-</span> p; as <span class="ot">&lt;-</span> many p; <span class="fu">return</span> (a<span class="op">:</span>as)}</span></code></pre></div>
<ul>
<li><code>option</code> makes use of the indeterminism provided by our
parser</li>
<li><code>many</code> takes a parser which will be parsed zero ore more
times.</li>
<li><code>many1</code> requires at least one parse</li>
</ul>
</div>
<div id="application-parse-csv-file" class="slide section level1">
<h1>Application: Parse CSV File</h1>
<p>First, we define a parser function for digits where the digits are
immediately turned into their integer representation.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>digit c </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a> <span class="op">|</span> <span class="ch">&#39;0&#39;</span> <span class="op">&lt;=</span> c <span class="op">&amp;&amp;</span> c <span class="op">&lt;=</span> <span class="ch">&#39;9&#39;</span> <span class="ot">=</span> <span class="dt">True</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a> <span class="op">|</span> <span class="fu">otherwise</span>            <span class="ot">=</span> <span class="dt">False</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ot">parseDigits ::</span> <span class="dt">Parser</span> <span class="dt">Int</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>parseDigits <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>   i <span class="ot">&lt;-</span> token <span class="op">$</span> many <span class="op">$</span> sat digit</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">return</span> (<span class="fu">read</span><span class="ot"> i ::</span> <span class="dt">Int</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>          <span class="co">-- read never fails here</span></span></code></pre></div>
<p>In the above, we make use of operator <code>$</code> to specify
function applications by omitting parantheses. The expression
<code>token $ many $ sat digit</code> is equivalent to
<code>token (many (sat digit))</code></p>
<p>In regular expression notation, <code>parseDigits</code>
expresses</p>
<pre><code>[&#39;0&#39;-&#39;9]+</code></pre>
<p>Additionally, in function <code>parseDigits</code> we ignore
white-space and convert the sequence of digits into an integer
value.</p>
<p>Next, we consider parsing of a single line consisting of a student ID
and a sequence of marks. We assume that each line is terminated by “new
line”. during parsing, we immediately sum up the marks.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>studentID <span class="ot">=</span> parseDigits</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>mark <span class="ot">=</span> parseDigits</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>delimiter <span class="ot">=</span> token <span class="op">$</span> sat (<span class="op">==</span><span class="ch">&#39;;&#39;</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="ot">parseAndSumLine ::</span> <span class="dt">Parser</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>parseAndSumLine <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">id</span> <span class="ot">&lt;-</span> studentID</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>   delimiter</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>   marks <span class="ot">&lt;-</span> many1 <span class="op">$</span> <span class="kw">do</span> m <span class="ot">&lt;-</span> mark</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>                       delimiter</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">return</span> m</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>   token <span class="op">$</span> sat (<span class="op">==</span><span class="ch">&#39;\n&#39;</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">return</span> (<span class="fu">id</span>,<span class="fu">sum</span> marks)</span></code></pre></div>
<p>In regular expression notation, the above is (roughly) equivalent
to</p>
<pre><code> [&#39;0&#39;-&#39;9&#39;]+ ; ([&#39;0&#39;-&#39;9&#39;]+ ;)+ &#39;\n&#39;</code></pre>
<p>Additionaly, function <code>parseAndSumLine</code> extracts the
student ID and immediately sums up the list of marks.</p>
<p>Parsing the complete file is straightforward.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>parseCSV <span class="ot">=</span> many1 parseAndSumLine</span></code></pre></div>
<p>Here’s the a variant of the earlier function <code>sumCVSFile</code>
which uses our simple CSV parser.</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>sumCSVFile fileName <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>   content <span class="ot">&lt;-</span> <span class="fu">readFile</span> fileName</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">case</span> (run parseCSV content) <span class="kw">of</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    ((xs,_)<span class="op">:</span>_) <span class="ot">-&gt;</span> <span class="kw">do</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>       <span class="kw">let</span> output <span class="ot">=</span> <span class="fu">unlines</span> <span class="op">$</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">map</span> (\(<span class="fu">id</span>,m) <span class="ot">-&gt;</span> <span class="fu">show</span> <span class="fu">id</span> <span class="op">++</span> <span class="st">&quot; ; &quot;</span> <span class="op">++</span> <span class="fu">show</span> m <span class="op">++</span> <span class="st">&quot; ; &quot;</span>) xs</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>       <span class="fu">writeFile</span> (fileName <span class="op">++</span> <span class="st">&quot;.sum&quot;</span>) output</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    [] <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;parse failure&quot;</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>testSumCSVFile <span class="ot">=</span> sumCSVFile <span class="st">&quot;sampleCSVFile.csv&quot;</span></span></code></pre></div>
</div>
<div id="imp-parser" class="slide section level1">
<h1>IMP Parser</h1>
<h2 id="abstract-syntax-of-imp">Abstract syntax of IMP</h2>
<div class="sourceCode" id="cb22"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Syntax</span> <span class="kw">where</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Var</span> <span class="ot">=</span> <span class="dt">String</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Val</span> <span class="ot">=</span> <span class="dt">N</span> <span class="dt">Int</span> <span class="op">|</span> <span class="dt">BTrue</span> <span class="op">|</span> <span class="dt">BFalse</span> <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Exp</span> <span class="ot">=</span> <span class="dt">Val</span> <span class="dt">Val</span> <span class="op">|</span> <span class="dt">Id</span> <span class="dt">Var</span> <span class="op">|</span> <span class="dt">Plus</span> <span class="dt">Exp</span> <span class="dt">Exp</span> <span class="op">|</span> <span class="dt">Minus</span> <span class="dt">Exp</span> <span class="dt">Exp</span> <span class="op">|</span> <span class="dt">Times</span> <span class="dt">Exp</span> <span class="dt">Exp</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>         <span class="op">|</span> <span class="dt">Div</span> <span class="dt">Exp</span> <span class="dt">Exp</span> <span class="op">|</span> <span class="dt">Equal</span> <span class="dt">Exp</span> <span class="dt">Exp</span> <span class="op">|</span> <span class="dt">Gt</span> <span class="dt">Exp</span> <span class="dt">Exp</span> <span class="op">|</span> <span class="dt">And</span> <span class="dt">Exp</span> <span class="dt">Exp</span> <span class="op">|</span> <span class="dt">Not</span> <span class="dt">Exp</span> <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Cmd</span> <span class="ot">=</span> <span class="dt">Skip</span> <span class="op">|</span> <span class="dt">Assign</span> <span class="dt">Var</span> <span class="dt">Exp</span> <span class="op">|</span> <span class="dt">Seq</span> <span class="dt">Cmd</span> <span class="dt">Cmd</span> <span class="op">|</span> <span class="dt">ITE</span> <span class="dt">Exp</span> <span class="dt">Cmd</span> <span class="dt">Cmd</span> </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>         <span class="op">|</span> <span class="dt">While</span> <span class="dt">Exp</span> <span class="dt">Cmd</span> <span class="op">|</span> <span class="dt">Newvar</span> <span class="dt">Var</span> <span class="dt">Exp</span> <span class="dt">Cmd</span> <span class="op">|</span> <span class="dt">Print</span> <span class="dt">Var</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>         <span class="kw">deriving</span> <span class="dt">Show</span></span></code></pre></div>
<h2 id="imp-parser-1">IMP Parser</h2>
<div class="sourceCode" id="cb23"><pre
class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co">-- IMP Parser</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Parser</span> <span class="kw">where</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Syntax</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">-- We define our own &#39;simple&#39; parser combinator library.</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">-- In practice, we should use a much better performing library such as Parsec.</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">------------------------------------------------------</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- The Parser Monad</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">Parser</span> a <span class="ot">=</span> <span class="dt">Parser</span> (<span class="dt">String</span> <span class="ot">-&gt;</span> [(a,<span class="dt">String</span>)])</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="ot">run ::</span> <span class="dt">Parser</span> t <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [(t, <span class="dt">String</span>)]</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>run (<span class="dt">Parser</span> p) s <span class="ot">=</span> p s</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>parse (<span class="dt">Parser</span> p) <span class="ot">=</span> p</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> <span class="dt">Parser</span> <span class="kw">where</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> a <span class="ot">=</span> <span class="dt">Parser</span> (\cs <span class="ot">-&gt;</span> [(a,cs)])</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  p <span class="op">&gt;&gt;=</span> f  <span class="ot">=</span> <span class="dt">Parser</span> (\cs <span class="ot">-&gt;</span> <span class="fu">concat</span> [parse (f a) cs&#39; <span class="op">|</span> (a,cs&#39;) <span class="ot">&lt;-</span> parse p cs])</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">MonadPlus</span> <span class="dt">Parser</span> <span class="kw">where</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  mzero <span class="ot">=</span> <span class="dt">Parser</span> (\cs <span class="ot">-&gt;</span>[])</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">`mplus`</span> q <span class="ot">=</span> <span class="dt">Parser</span> (\cs <span class="ot">-&gt;</span> parse p cs <span class="op">++</span> parse q cs)</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="co">------------------------</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="co">-- Some combinators </span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- deterministic (first) choice</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="ot">(+++) ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> a</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>(<span class="op">+++</span>) p q <span class="ot">=</span> <span class="dt">Parser</span> ( \cs <span class="ot">-&gt;</span> <span class="kw">case</span> parse (p <span class="ot">`mplus`</span> q) cs <span class="kw">of</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>                           []     <span class="ot">-&gt;</span> []</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>                           (x<span class="op">:</span>xs) <span class="ot">-&gt;</span> [x] )</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a><span class="ot">try ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> a</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>try p <span class="ot">=</span> <span class="dt">Parser</span> ( \cs <span class="ot">-&gt;</span> <span class="kw">case</span> parse p cs <span class="kw">of</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>                          []     <span class="ot">-&gt;</span> [(<span class="fu">undefined</span>,cs)]</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>                          (x<span class="op">:</span>xs) <span class="ot">-&gt;</span> [x] )</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a><span class="co">-- unconditionally parse a single character</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a><span class="ot">item ::</span> <span class="dt">Parser</span> <span class="dt">Char</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>item <span class="ot">=</span> <span class="dt">Parser</span> (\cs <span class="ot">-&gt;</span> <span class="kw">case</span> cs <span class="kw">of</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;&quot;</span>     <span class="ot">-&gt;</span> []</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>                       (c<span class="op">:</span>cs) <span class="ot">-&gt;</span> [(c,cs)])</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a><span class="ot">sat ::</span> (<span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Char</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>sat p <span class="ot">=</span> <span class="kw">do</span> { c <span class="ot">&lt;-</span> item; <span class="kw">if</span> p c <span class="kw">then</span> <span class="fu">return</span> c <span class="kw">else</span> mzero }</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a><span class="ot">char ::</span> <span class="dt">Char</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Char</span></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>char c <span class="ot">=</span> sat (c <span class="op">==</span>)</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a><span class="co">-- parse a specific string</span></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a><span class="ot">string ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">String</span></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>string <span class="st">&quot;&quot;</span> <span class="ot">=</span> <span class="fu">return</span> <span class="st">&quot;&quot;</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>string (c<span class="op">:</span>cs) <span class="ot">=</span> <span class="kw">do</span> {char c; string cs; <span class="fu">return</span> (c<span class="op">:</span>cs)}</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a><span class="co">-- option</span></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a><span class="ot">option ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> [a]</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>option p <span class="ot">=</span> (<span class="kw">do</span> x <span class="ot">&lt;-</span> p</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>               <span class="fu">return</span> [x])</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>           <span class="op">+++</span> <span class="fu">return</span> []</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a><span class="co">-- zero or more repetitions</span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a><span class="ot">many ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> [a]</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>many p <span class="ot">=</span> many1 p <span class="op">+++</span> <span class="fu">return</span> []</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a><span class="co">-- one or more repetitions</span></span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a><span class="ot">many1 ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> [a]</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>many1 p <span class="ot">=</span> <span class="kw">do</span> {a <span class="ot">&lt;-</span> p; as <span class="ot">&lt;-</span> many p; <span class="fu">return</span> (a<span class="op">:</span>as)}</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a><span class="co">-- parse a token, throwing away any leading/trailing spaces</span></span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a><span class="ot">token ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> a </span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>token p <span class="ot">=</span> <span class="kw">do</span> {space; a <span class="ot">&lt;-</span> p; space; <span class="fu">return</span> a}</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a><span class="co">-- string token</span></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a><span class="ot">stoken ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">String</span></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>stoken s <span class="ot">=</span> token <span class="op">$</span> string s</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a><span class="co">-- parse a string of spaces, tabs</span></span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a><span class="ot">space ::</span> <span class="dt">Parser</span> <span class="dt">String</span></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>space <span class="ot">=</span> many (sat (\c <span class="ot">-&gt;</span> <span class="kw">case</span> c <span class="kw">of</span></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>                          <span class="ch">&#39; &#39;</span>  <span class="ot">-&gt;</span> <span class="dt">True</span></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>                          <span class="ch">&#39;\t&#39;</span> <span class="ot">-&gt;</span> <span class="dt">True</span></span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>                          _    <span class="ot">-&gt;</span> <span class="dt">False</span>))</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a><span class="co">-------------------------------------</span></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a><span class="co">-- Application: parse IMP</span></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a><span class="co">{-</span></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a><span class="co">We roughly follow the EBNF style grammar notation</span></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a><span class="co">http://en.wikipedia.org/wiki/Extended_Backus–Naur_Formhttp://en.wikipedia.org/wiki/Extended_Backus–Naur_Form</span></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a><span class="co">{ ... } stands for repetition</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a><span class="co">[ ... ] stands for option</span></span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a><span class="co">operator precedence from top (highest) to bottom (lowest)</span></span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a><span class="co">* /</span></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a><span class="co">+ -</span></span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a><span class="co">&gt;</span></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a><span class="co">==</span></span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a><span class="co">&amp;&amp;</span></span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a><span class="co">||   -- not supported</span></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a><span class="co">prog ::=  decls &quot;{&quot; prog &quot;}&quot;</span></span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a><span class="co">      |   cmd { &quot;;&quot; prog  }</span></span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a><span class="co">decls ::= &quot;var&quot; decl { &quot;;&quot; decl }</span></span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a><span class="co">decl ::= vars &quot;:=&quot; bexp</span></span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a><span class="co">cmd ::= &quot;skip&quot;</span></span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a><span class="co">     | vars &quot;:=&quot; bexp</span></span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a><span class="co">     | &quot;if&quot; &quot;(&quot; bexp &quot;)&quot; &quot;{&quot; prog &quot;}&quot; &quot;else&quot; &quot;{&quot; prog &quot;}&quot;</span></span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a><span class="co">     | &quot;while&quot; &quot;(&quot; bexp &quot;)&quot; &quot;{&quot; prog &quot;}&quot;</span></span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a><span class="co">     | &quot;print&quot; vars</span></span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a><span class="co">bexp ::= cexp { &quot;&amp;&amp;&quot; cexp }</span></span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a><span class="co">cexp ::= cterm [ &quot;==&quot; cterm ]</span></span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a><span class="co">cterm ::= aexp [ &quot;&gt;&quot; aexp ]</span></span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a><span class="co">aexp ::= term { &quot;+&quot; term | &quot;-&quot; term }</span></span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a><span class="co">term ::= factor { &quot;*&quot; factor | &quot;/&quot; factor }</span></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a><span class="co">factor ::=  ints | bools | vars | &quot;!&quot; factor | &quot;(&quot; bexp &quot;)&quot;</span></span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a><span class="co">digit ::= &#39;0&#39; | ... | &#39;9&#39;</span></span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a><span class="co">ints ::=  digit { digit }</span></span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a><span class="co">bools ::= &#39;true&#39; | &#39;false&#39;</span></span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a><span class="co">letter ::= &#39;a&#39; | ... | &#39;z&#39;</span></span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a><span class="co">vars ::=  letter { digit | letter }</span></span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a><span class="co">-}</span></span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a><span class="co">-- There&#39;s no proceeding lexing phase. </span></span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a><span class="co">-- We take care of white space by scanning </span></span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a><span class="co">-- operators and keywords via s(tring)token.</span></span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a><span class="ot">prog ::</span> <span class="dt">Parser</span> <span class="dt">Cmd</span></span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a>prog <span class="ot">=</span> (<span class="kw">do</span> try <span class="op">$</span> stoken <span class="st">&quot;var&quot;</span></span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a>           (v,e) <span class="ot">&lt;-</span> decl</span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a>           ds <span class="ot">&lt;-</span> many <span class="op">$</span> <span class="kw">do</span> stoken <span class="st">&quot;;&quot;</span></span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a>                           d <span class="ot">&lt;-</span> decl</span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">return</span> d</span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a>           stoken <span class="st">&quot;{&quot;</span></span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a>           p <span class="ot">&lt;-</span> prog</span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a>           stoken <span class="st">&quot;}&quot;</span></span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a>           <span class="fu">return</span> <span class="op">$</span> <span class="fu">foldl</span> (\c <span class="ot">-&gt;</span> \(v,e) <span class="ot">-&gt;</span> <span class="dt">Newvar</span> v e c) </span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a>                          (<span class="dt">Newvar</span> v e p) </span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a>                          ds)</span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a>       <span class="op">+++</span></span>
<span id="cb23-183"><a href="#cb23-183" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">do</span> c <span class="ot">&lt;-</span> cmd</span>
<span id="cb23-184"><a href="#cb23-184" aria-hidden="true" tabindex="-1"></a>           cs <span class="ot">&lt;-</span> many <span class="op">$</span> <span class="kw">do</span> stoken <span class="st">&quot;;&quot;</span></span>
<span id="cb23-185"><a href="#cb23-185" aria-hidden="true" tabindex="-1"></a>                           c <span class="ot">&lt;-</span> prog</span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">return</span> c</span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a>           <span class="fu">return</span> <span class="op">$</span> <span class="fu">foldl</span> <span class="dt">Seq</span> c cs)</span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a><span class="ot">decl ::</span> <span class="dt">Parser</span> (<span class="dt">String</span>,<span class="dt">Exp</span>)</span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a>decl <span class="ot">=</span> <span class="kw">do</span> (<span class="dt">Id</span> x) <span class="ot">&lt;-</span> vars</span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;:=&quot;</span></span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a>          e <span class="ot">&lt;-</span> bexp</span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span> (x,e)</span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a><span class="co">-- </span><span class="al">TODO</span><span class="co">: variables names such as ifx</span></span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a><span class="ot">cmd ::</span> <span class="dt">Parser</span> <span class="dt">Cmd</span></span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a>cmd <span class="ot">=</span> (<span class="kw">do</span> stoken <span class="st">&quot;skip&quot;</span></span>
<span id="cb23-199"><a href="#cb23-199" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span> <span class="dt">Skip</span>)</span>
<span id="cb23-200"><a href="#cb23-200" aria-hidden="true" tabindex="-1"></a>      <span class="op">+++</span></span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">do</span> stoken <span class="st">&quot;print&quot;</span></span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a>          (<span class="dt">Id</span> v) <span class="ot">&lt;-</span> vars</span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span> <span class="op">$</span> <span class="dt">Print</span> v)</span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a>      <span class="op">+++</span></span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">do</span> stoken <span class="st">&quot;if&quot;</span></span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;(&quot;</span></span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a>          b <span class="ot">&lt;-</span> bexp</span>
<span id="cb23-208"><a href="#cb23-208" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;)&quot;</span></span>
<span id="cb23-209"><a href="#cb23-209" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;{&quot;</span></span>
<span id="cb23-210"><a href="#cb23-210" aria-hidden="true" tabindex="-1"></a>          t <span class="ot">&lt;-</span> prog</span>
<span id="cb23-211"><a href="#cb23-211" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;}&quot;</span></span>
<span id="cb23-212"><a href="#cb23-212" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;else&quot;</span></span>
<span id="cb23-213"><a href="#cb23-213" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;{&quot;</span></span>
<span id="cb23-214"><a href="#cb23-214" aria-hidden="true" tabindex="-1"></a>          e <span class="ot">&lt;-</span> prog</span>
<span id="cb23-215"><a href="#cb23-215" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;}&quot;</span></span>
<span id="cb23-216"><a href="#cb23-216" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span> <span class="op">$</span> <span class="dt">ITE</span> b t e)</span>
<span id="cb23-217"><a href="#cb23-217" aria-hidden="true" tabindex="-1"></a>      <span class="op">+++</span></span>
<span id="cb23-218"><a href="#cb23-218" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">do</span> stoken <span class="st">&quot;while&quot;</span></span>
<span id="cb23-219"><a href="#cb23-219" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;(&quot;</span></span>
<span id="cb23-220"><a href="#cb23-220" aria-hidden="true" tabindex="-1"></a>          b <span class="ot">&lt;-</span> bexp</span>
<span id="cb23-221"><a href="#cb23-221" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;)&quot;</span></span>
<span id="cb23-222"><a href="#cb23-222" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;{&quot;</span></span>
<span id="cb23-223"><a href="#cb23-223" aria-hidden="true" tabindex="-1"></a>          c <span class="ot">&lt;-</span> prog</span>
<span id="cb23-224"><a href="#cb23-224" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;}&quot;</span></span>
<span id="cb23-225"><a href="#cb23-225" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span> <span class="op">$</span> <span class="dt">While</span> b c)</span>
<span id="cb23-226"><a href="#cb23-226" aria-hidden="true" tabindex="-1"></a>      <span class="op">+++</span></span>
<span id="cb23-227"><a href="#cb23-227" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">do</span> (<span class="dt">Id</span> v) <span class="ot">&lt;-</span> vars</span>
<span id="cb23-228"><a href="#cb23-228" aria-hidden="true" tabindex="-1"></a>          stoken <span class="st">&quot;:=&quot;</span></span>
<span id="cb23-229"><a href="#cb23-229" aria-hidden="true" tabindex="-1"></a>          b <span class="ot">&lt;-</span> bexp</span>
<span id="cb23-230"><a href="#cb23-230" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span> <span class="op">$</span> <span class="dt">Assign</span> v b)   </span>
<span id="cb23-231"><a href="#cb23-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-232"><a href="#cb23-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-233"><a href="#cb23-233" aria-hidden="true" tabindex="-1"></a><span class="ot">bexp ::</span> <span class="dt">Parser</span> <span class="dt">Exp</span></span>
<span id="cb23-234"><a href="#cb23-234" aria-hidden="true" tabindex="-1"></a>bexp <span class="ot">=</span> <span class="kw">do</span> x <span class="ot">&lt;-</span> cexp</span>
<span id="cb23-235"><a href="#cb23-235" aria-hidden="true" tabindex="-1"></a>          ys <span class="ot">&lt;-</span> many <span class="op">$</span> <span class="kw">do</span> stoken <span class="st">&quot;&amp;&amp;&quot;</span></span>
<span id="cb23-236"><a href="#cb23-236" aria-hidden="true" tabindex="-1"></a>                          y <span class="ot">&lt;-</span> cexp</span>
<span id="cb23-237"><a href="#cb23-237" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">return</span> y</span>
<span id="cb23-238"><a href="#cb23-238" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span> <span class="op">$</span> <span class="fu">foldl</span> <span class="dt">And</span> x ys</span>
<span id="cb23-239"><a href="#cb23-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-240"><a href="#cb23-240" aria-hidden="true" tabindex="-1"></a><span class="ot">cexp ::</span> <span class="dt">Parser</span> <span class="dt">Exp</span></span>
<span id="cb23-241"><a href="#cb23-241" aria-hidden="true" tabindex="-1"></a>cexp <span class="ot">=</span>  <span class="kw">do</span> x <span class="ot">&lt;-</span> cterm</span>
<span id="cb23-242"><a href="#cb23-242" aria-hidden="true" tabindex="-1"></a>           ((<span class="kw">do</span> stoken <span class="st">&quot;==&quot;</span></span>
<span id="cb23-243"><a href="#cb23-243" aria-hidden="true" tabindex="-1"></a>                y <span class="ot">&lt;-</span> cterm</span>
<span id="cb23-244"><a href="#cb23-244" aria-hidden="true" tabindex="-1"></a>                <span class="fu">return</span> <span class="op">$</span> <span class="dt">Equal</span> x y)</span>
<span id="cb23-245"><a href="#cb23-245" aria-hidden="true" tabindex="-1"></a>             <span class="op">+++</span></span>
<span id="cb23-246"><a href="#cb23-246" aria-hidden="true" tabindex="-1"></a>             (<span class="fu">return</span> x))</span>
<span id="cb23-247"><a href="#cb23-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-248"><a href="#cb23-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-249"><a href="#cb23-249" aria-hidden="true" tabindex="-1"></a><span class="ot">cterm ::</span> <span class="dt">Parser</span> <span class="dt">Exp</span></span>
<span id="cb23-250"><a href="#cb23-250" aria-hidden="true" tabindex="-1"></a>cterm <span class="ot">=</span> <span class="kw">do</span> x <span class="ot">&lt;-</span> aexp</span>
<span id="cb23-251"><a href="#cb23-251" aria-hidden="true" tabindex="-1"></a>           ((<span class="kw">do</span> stoken <span class="st">&quot;&gt;&quot;</span></span>
<span id="cb23-252"><a href="#cb23-252" aria-hidden="true" tabindex="-1"></a>                y <span class="ot">&lt;-</span> aexp</span>
<span id="cb23-253"><a href="#cb23-253" aria-hidden="true" tabindex="-1"></a>                <span class="fu">return</span> <span class="op">$</span> <span class="dt">Gt</span> x y)</span>
<span id="cb23-254"><a href="#cb23-254" aria-hidden="true" tabindex="-1"></a>            <span class="op">+++</span></span>
<span id="cb23-255"><a href="#cb23-255" aria-hidden="true" tabindex="-1"></a>            (<span class="fu">return</span> x))</span>
<span id="cb23-256"><a href="#cb23-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-257"><a href="#cb23-257" aria-hidden="true" tabindex="-1"></a><span class="co">-- +/- right associative</span></span>
<span id="cb23-258"><a href="#cb23-258" aria-hidden="true" tabindex="-1"></a><span class="ot">aexp ::</span> <span class="dt">Parser</span> <span class="dt">Exp</span></span>
<span id="cb23-259"><a href="#cb23-259" aria-hidden="true" tabindex="-1"></a>aexp <span class="ot">=</span> <span class="kw">do</span> x <span class="ot">&lt;-</span> term</span>
<span id="cb23-260"><a href="#cb23-260" aria-hidden="true" tabindex="-1"></a>          ys <span class="ot">&lt;-</span> many <span class="op">$</span> (<span class="kw">do</span> stoken <span class="st">&quot;+&quot;</span></span>
<span id="cb23-261"><a href="#cb23-261" aria-hidden="true" tabindex="-1"></a>                           y <span class="ot">&lt;-</span> term</span>
<span id="cb23-262"><a href="#cb23-262" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">return</span> (<span class="ch">&#39;+&#39;</span>,y))</span>
<span id="cb23-263"><a href="#cb23-263" aria-hidden="true" tabindex="-1"></a>                       <span class="op">+++</span></span>
<span id="cb23-264"><a href="#cb23-264" aria-hidden="true" tabindex="-1"></a>                       (<span class="kw">do</span> stoken <span class="st">&quot;-&quot;</span></span>
<span id="cb23-265"><a href="#cb23-265" aria-hidden="true" tabindex="-1"></a>                           y <span class="ot">&lt;-</span> term</span>
<span id="cb23-266"><a href="#cb23-266" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">return</span> (<span class="ch">&#39;-&#39;</span>,y))</span>
<span id="cb23-267"><a href="#cb23-267" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span> <span class="op">$</span> <span class="fu">foldl</span> (\a <span class="ot">-&gt;</span> \(op,b) <span class="ot">-&gt;</span></span>
<span id="cb23-268"><a href="#cb23-268" aria-hidden="true" tabindex="-1"></a>                             <span class="kw">case</span> op <span class="kw">of</span></span>
<span id="cb23-269"><a href="#cb23-269" aria-hidden="true" tabindex="-1"></a>                               <span class="ch">&#39;+&#39;</span> <span class="ot">-&gt;</span> <span class="dt">Plus</span> a b</span>
<span id="cb23-270"><a href="#cb23-270" aria-hidden="true" tabindex="-1"></a>                               <span class="ch">&#39;-&#39;</span> <span class="ot">-&gt;</span> <span class="dt">Minus</span> a b)</span>
<span id="cb23-271"><a href="#cb23-271" aria-hidden="true" tabindex="-1"></a>                         x ys</span>
<span id="cb23-272"><a href="#cb23-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-273"><a href="#cb23-273" aria-hidden="true" tabindex="-1"></a><span class="ot">term ::</span> <span class="dt">Parser</span> <span class="dt">Exp</span></span>
<span id="cb23-274"><a href="#cb23-274" aria-hidden="true" tabindex="-1"></a>term <span class="ot">=</span> <span class="kw">do</span> x <span class="ot">&lt;-</span> factor</span>
<span id="cb23-275"><a href="#cb23-275" aria-hidden="true" tabindex="-1"></a>          ys <span class="ot">&lt;-</span> many <span class="op">$</span> (<span class="kw">do</span> stoken <span class="st">&quot;*&quot;</span></span>
<span id="cb23-276"><a href="#cb23-276" aria-hidden="true" tabindex="-1"></a>                           y <span class="ot">&lt;-</span> factor</span>
<span id="cb23-277"><a href="#cb23-277" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">return</span> (<span class="ch">&#39;*&#39;</span>,y))</span>
<span id="cb23-278"><a href="#cb23-278" aria-hidden="true" tabindex="-1"></a>                       <span class="op">+++</span></span>
<span id="cb23-279"><a href="#cb23-279" aria-hidden="true" tabindex="-1"></a>                       (<span class="kw">do</span> stoken <span class="st">&quot;/&quot;</span></span>
<span id="cb23-280"><a href="#cb23-280" aria-hidden="true" tabindex="-1"></a>                           y <span class="ot">&lt;-</span> factor</span>
<span id="cb23-281"><a href="#cb23-281" aria-hidden="true" tabindex="-1"></a>                           <span class="fu">return</span> (<span class="ch">&#39;/&#39;</span>,y))</span>
<span id="cb23-282"><a href="#cb23-282" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span> <span class="op">$</span> <span class="fu">foldl</span> (\a <span class="ot">-&gt;</span> \(op,b) <span class="ot">-&gt;</span></span>
<span id="cb23-283"><a href="#cb23-283" aria-hidden="true" tabindex="-1"></a>                             <span class="kw">case</span> op <span class="kw">of</span></span>
<span id="cb23-284"><a href="#cb23-284" aria-hidden="true" tabindex="-1"></a>                               <span class="ch">&#39;*&#39;</span> <span class="ot">-&gt;</span> <span class="dt">Times</span> a b</span>
<span id="cb23-285"><a href="#cb23-285" aria-hidden="true" tabindex="-1"></a>                               <span class="ch">&#39;/&#39;</span> <span class="ot">-&gt;</span> <span class="dt">Div</span> a b)</span>
<span id="cb23-286"><a href="#cb23-286" aria-hidden="true" tabindex="-1"></a>                         x ys</span>
<span id="cb23-287"><a href="#cb23-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-288"><a href="#cb23-288" aria-hidden="true" tabindex="-1"></a><span class="ot">factor ::</span> <span class="dt">Parser</span> <span class="dt">Exp</span></span>
<span id="cb23-289"><a href="#cb23-289" aria-hidden="true" tabindex="-1"></a>factor <span class="ot">=</span> ints <span class="op">+++</span> bools <span class="op">+++</span> vars <span class="op">+++</span></span>
<span id="cb23-290"><a href="#cb23-290" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">do</span> stoken <span class="st">&quot;!&quot;</span></span>
<span id="cb23-291"><a href="#cb23-291" aria-hidden="true" tabindex="-1"></a>             x <span class="ot">&lt;-</span> factor</span>
<span id="cb23-292"><a href="#cb23-292" aria-hidden="true" tabindex="-1"></a>             <span class="fu">return</span> <span class="op">$</span> <span class="dt">Not</span> x)</span>
<span id="cb23-293"><a href="#cb23-293" aria-hidden="true" tabindex="-1"></a>         <span class="op">+++</span></span>
<span id="cb23-294"><a href="#cb23-294" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">do</span> (stoken <span class="st">&quot;(&quot;</span>)</span>
<span id="cb23-295"><a href="#cb23-295" aria-hidden="true" tabindex="-1"></a>             x <span class="ot">&lt;-</span> bexp</span>
<span id="cb23-296"><a href="#cb23-296" aria-hidden="true" tabindex="-1"></a>             stoken <span class="st">&quot;)&quot;</span></span>
<span id="cb23-297"><a href="#cb23-297" aria-hidden="true" tabindex="-1"></a>             <span class="fu">return</span> x) </span>
<span id="cb23-298"><a href="#cb23-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-299"><a href="#cb23-299" aria-hidden="true" tabindex="-1"></a><span class="fu">isDigit</span> c  <span class="ot">=</span> <span class="ch">&#39;0&#39;</span> <span class="op">&lt;=</span> c <span class="op">&amp;&amp;</span> c <span class="op">&lt;=</span> <span class="ch">&#39;9&#39;</span> </span>
<span id="cb23-300"><a href="#cb23-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-301"><a href="#cb23-301" aria-hidden="true" tabindex="-1"></a>isLetter c <span class="ot">=</span> <span class="ch">&#39;a&#39;</span> <span class="op">&lt;=</span> c <span class="op">&amp;&amp;</span> c <span class="op">&lt;=</span> <span class="ch">&#39;z&#39;</span></span>
<span id="cb23-302"><a href="#cb23-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-303"><a href="#cb23-303" aria-hidden="true" tabindex="-1"></a><span class="ot">ints ::</span> <span class="dt">Parser</span> <span class="dt">Exp</span></span>
<span id="cb23-304"><a href="#cb23-304" aria-hidden="true" tabindex="-1"></a>ints <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb23-305"><a href="#cb23-305" aria-hidden="true" tabindex="-1"></a>   i <span class="ot">&lt;-</span> many1 <span class="op">$</span> sat <span class="fu">isDigit</span></span>
<span id="cb23-306"><a href="#cb23-306" aria-hidden="true" tabindex="-1"></a>   <span class="fu">return</span> <span class="op">$</span> <span class="dt">Val</span> <span class="op">$</span> <span class="dt">N</span> (<span class="fu">read</span><span class="ot"> i ::</span> <span class="dt">Int</span>)</span>
<span id="cb23-307"><a href="#cb23-307" aria-hidden="true" tabindex="-1"></a>          <span class="co">-- read never fails here</span></span>
<span id="cb23-308"><a href="#cb23-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-309"><a href="#cb23-309" aria-hidden="true" tabindex="-1"></a><span class="ot">bools ::</span> <span class="dt">Parser</span> <span class="dt">Exp</span></span>
<span id="cb23-310"><a href="#cb23-310" aria-hidden="true" tabindex="-1"></a>bools <span class="ot">=</span> (<span class="kw">do</span> string <span class="st">&quot;true&quot;</span></span>
<span id="cb23-311"><a href="#cb23-311" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span> <span class="op">$</span> <span class="dt">Val</span> <span class="dt">BTrue</span>)</span>
<span id="cb23-312"><a href="#cb23-312" aria-hidden="true" tabindex="-1"></a>         <span class="op">+++</span> </span>
<span id="cb23-313"><a href="#cb23-313" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">do</span> string <span class="st">&quot;false&quot;</span></span>
<span id="cb23-314"><a href="#cb23-314" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span> <span class="op">$</span> <span class="dt">Val</span> <span class="dt">BFalse</span>)</span>
<span id="cb23-315"><a href="#cb23-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-316"><a href="#cb23-316" aria-hidden="true" tabindex="-1"></a><span class="ot">vars ::</span> <span class="dt">Parser</span> <span class="dt">Exp</span></span>
<span id="cb23-317"><a href="#cb23-317" aria-hidden="true" tabindex="-1"></a>vars <span class="ot">=</span> <span class="kw">do</span> x <span class="ot">&lt;-</span> sat isLetter</span>
<span id="cb23-318"><a href="#cb23-318" aria-hidden="true" tabindex="-1"></a>          xs <span class="ot">&lt;-</span> many <span class="op">$</span> sat (\c <span class="ot">-&gt;</span> <span class="fu">isDigit</span> c <span class="op">||</span> isLetter c)</span>
<span id="cb23-319"><a href="#cb23-319" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span> <span class="op">$</span> <span class="dt">Id</span> (x<span class="op">:</span>xs)</span></code></pre></div>
</div>
</body>
</html>
